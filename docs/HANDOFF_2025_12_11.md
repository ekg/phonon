# Handoff: Phonon Bug Fixes Session (2025-12-11)

## Completed

### 1. Modifier Bus Multiplication Bug ✅
**Fixed:** `~amp # 0.5; saw 220 * ~amp` now works (was producing silence)
- Fix in `src/compositional_compiler.rs:731-736`
- Added check for `modifier_buses` in `compile_expr` BusRef handling
- Signal operators (`~+`, `~*`) also fixed by same change

### 2. Scale Locking & Arpeggiator for MIDI ✅
- `saw ~midi:c:major` - scale lock
- `saw ~midi:arp:up:4` - arpeggiator
- Committed in `9c5876b`

### 3. Reverb Investigation ✅
- Reverb IS working (adds 1.26x tail energy)
- Both `reverb` (Freeverb) and `plate` (Dattorro) functional
- Tests in `tests/test_reverb_modulation.rs`, `tests/test_reverb_ringout.rs`

## Completed (continued)

### 4. Pattern-Triggered Oscillators - FIXED ✅
**Before:**
- `saw "c4 e4 g4"` played continuous, didn't trigger per note
- Required ugly `saw_trig` syntax as workaround

**After:**
- `saw "c4 e4 g4"` ✅ now triggers per-note automatically
- `saw "[c4, e4, g4]"` ✅ plays chords
- `saw 440` ✅ still works as continuous oscillator
- `saw ~midi` ✅ still works for MIDI input

**Fix:** Added `is_note_pattern_string()` helper in `compile_oscillator()` (~line 3296) that detects note names (a-g with optional #/b and octave digit). When detected, routes to `compile_synth_pattern()` for per-note triggering.

Tests: `tests/test_note_pattern_osc.rs` (18 tests)

### 5. Customizable ADSR for MIDI Polysynth ✅
**Before:**
- `sine ~midi` had hardcoded envelope (10ms attack, 300ms release)
- No way to customize envelope from DSL

**After:**
- `sine ~midi :attack 0.1 :release 2.0` - customizable envelope
- Defaults preserved when not specified

**Fix:** Added `get_optional_keyword` to ParamExtractor, modified `compile_oscillator` to extract `:attack`/`:release` and pass to `compile_midi_poly_synth`.

Tests: `tests/test_midi_poly_adsr.rs`

### 6. Note Function & Bus Indirection ✅
**Before:**
- `note` only worked with samples
- `~notes $ "c4 e4 g4"; saw ~notes` created continuous oscillator (wrong)
- No way to get continuous pitch pattern without triggering

**After:**
- `note "c4 e4 g4"` - standalone function creates frequency pattern
- `saw $ note "c4 e4 g4"` - continuous oscillator with changing pitch (no envelope)
- `saw "c4 e4 g4"` - triggered per-note with envelope
- `~notes $ "c4 e4 g4"; saw ~notes` - now triggers per-note ✅

**Summary of behaviors:**
| Syntax | Behavior |
|--------|----------|
| `saw "c4 e4 g4"` | Triggered per-note (with envelope) |
| `saw $ note "c4 e4 g4"` | Continuous, pitch changes (no envelope) |
| `~n $ "c4 e4"; saw ~n` | Triggered (bus indirection works) |

**Fix:**
- Modified `compile_note_modifier` to work standalone (1 arg creates pattern)
- Added bus expression lookup in `compile_oscillator` to detect note patterns via indirection

Tests: `tests/test_note_function.rs` (6 tests)

## Commits This Session
```
d5b98e3 Add modifier bus tests for signal operators
dcb86f8 Fix modifier bus multiplication and add reverb tests
9c5876b Add scale locking and arpeggiator for MIDI polyphonic synthesis
```

## Key Files
- `src/compositional_compiler.rs` - main compilation logic
- `src/unified_graph.rs` - signal nodes
- `tests/test_reverb_*.rs` - new reverb tests
- `piano.ph` - updated to use `saw_trig` as workaround
