# Noise Generators for Reverb Modulation

High-quality, deterministic noise generators optimized for reverb modulation and sound synthesis.

## Overview

This module provides four types of noise generators, each with different spectral characteristics:

1. **White Noise** - Flat spectrum (equal power at all frequencies)
2. **Pink Noise** - 1/f spectrum (~-3dB/octave), natural-sounding
3. **Brown Noise** - 1/f² spectrum (~-6dB/octave), smooth and dark
4. **Fractal Brownian Motion (fBM)** - Multi-octave noise with controllable character

All generators are:
- **Deterministic**: Same seed produces same output
- **Efficient**: No heap allocations in hot path
- **Normalized**: Output range approximately -1.0 to 1.0
- **Tested**: Comprehensive unit tests verify correctness

## Usage

### White Noise

```rust
use phonon::nodes::noise_generators::WhiteNoise;

let mut gen = WhiteNoise::new(12345); // Seed for determinism
for _ in 0..100 {
    let sample = gen.next_sample(); // -1.0 to 1.0
}
```

**Characteristics:**
- Flat frequency spectrum (all frequencies have equal power)
- RMS ≈ 0.577 for uniform distribution in [-1, 1]
- Good for: early reflections, diffusion, general noise source

### Pink Noise

```rust
use phonon::nodes::noise_generators::PinkNoise;

let mut gen = PinkNoise::new(12345);
for _ in 0..100 {
    let sample = gen.next_sample();
}
```

**Characteristics:**
- 1/f spectrum (power decreases ~3dB per octave)
- More natural-sounding than white noise
- Uses Voss-McCartney algorithm (O(log N) complexity)
- Good for: reverb tail modulation, natural room character

**Implementation:**
- 16 independent random generators updating at different rates
- Generator i updates every 2^i samples
- Efficiently computes multi-octave noise in constant time

### Brown Noise

```rust
use phonon::nodes::noise_generators::BrownNoise;

let mut gen = BrownNoise::new(12345);
for _ in 0..100 {
    let sample = gen.next_sample();
}
```

**Characteristics:**
- 1/f² spectrum (power decreases ~6dB per octave)
- Smooth, dark, low-frequency dominant
- Generated by integrating white noise (random walk)
- Includes DC blocking to prevent unbounded drift
- Good for: smooth modulation, gentle chorus, LFO-like effects

### Fractal Brownian Motion (fBM)

```rust
use phonon::nodes::noise_generators::FractalBrownianMotion;

// Create with parameters:
// - seed: 12345
// - octaves: 4 (number of noise layers)
// - lacunarity: 2.0 (frequency multiplier between octaves)
// - persistence: 0.5 (amplitude multiplier between octaves)
let mut gen = FractalBrownianMotion::new(12345, 4, 2.0, 0.5);

// Generate samples
for _ in 0..100 {
    let sample = gen.next_sample();
}

// Or use as LFO with frequency control
let sample_rate = 44100.0;
let frequency = 0.5; // 0.5 Hz
let sample = gen.next_sample_at_rate(frequency, sample_rate);
```

**Parameters:**
- **octaves**: Number of noise layers (1-16 recommended, more = more detail)
- **lacunarity**: Frequency multiplier between octaves (typically 2.0)
  - Higher values = more contrast between octaves
- **persistence**: Amplitude multiplier between octaves
  - 0.5 ≈ 1/f (pink-ish noise)
  - 0.25 ≈ 1/f² (brown-ish noise)
  - 0.75 = more high-frequency content

**Characteristics:**
- Complex, natural-sounding textures
- Controllable spectral shape via persistence
- Each octave runs at frequency × lacunarity^i
- Each octave has amplitude × persistence^i
- Good for: complex reverb modulation, natural textures, evolving drones

**Common Configurations:**

```rust
// Natural reverb modulation (pink-ish)
let gen = FractalBrownianMotion::new(seed, 4, 2.0, 0.5);

// Smooth, dark modulation (brown-ish)
let gen = FractalBrownianMotion::new(seed, 3, 2.0, 0.25);

// Detailed, bright texture
let gen = FractalBrownianMotion::new(seed, 6, 2.0, 0.75);

// Low-frequency LFO for reverb (0.1 - 1 Hz)
let gen = FractalBrownianMotion::new(seed, 3, 2.0, 0.5);
let sample = gen.next_sample_at_rate(0.2, 44100.0);
```

## Reverb Use Cases

### Early Reflections & Diffusion
**Use:** White Noise
**Why:** Flat spectrum creates uniform reflection patterns

```rust
let mut noise = WhiteNoise::new(seed);
// Modulate early reflection delays by ±1 sample
let jitter = noise.next_sample() * 0.5; // -0.5 to 0.5 samples
```

### Tail Modulation (Warm & Natural)
**Use:** Pink Noise or fBM
**Why:** Natural 1/f character mimics real room variations

```rust
let mut noise = PinkNoise::new(seed);
// Modulate allpass delay by ±2 samples at low frequency
let modulation = noise.next_sample() * 2.0;
```

### Smooth Chorus Effects
**Use:** Brown Noise or low-persistence fBM
**Why:** Smooth, slow variation creates gentle pitch modulation

```rust
let mut noise = BrownNoise::new(seed);
// Very gentle pitch variation
let chorus = noise.next_sample() * 0.001; // ±0.001 semitones
```

### Complex Natural Modulation
**Use:** fBM with 3-5 octaves
**Why:** Multi-scale variation mimics real acoustic spaces

```rust
let mut fbm = FractalBrownianMotion::new(seed, 4, 2.0, 0.5);
// Modulate multiple parameters at once
let mod1 = fbm.next_sample();
let mod2 = fbm.next_sample();
// Apply to delay time, filter cutoff, etc.
```

### Very Slow Drift (LFO-style)
**Use:** fBM with `next_sample_at_rate()`
**Why:** Controlled frequency creates predictable modulation

```rust
let mut fbm = FractalBrownianMotion::new(seed, 3, 2.0, 0.5);
// 0.2 Hz modulation (5 second period)
for sample in audio_buffer {
    let lfo = fbm.next_sample_at_rate(0.2, 44100.0);
    // Use lfo to modulate reverb parameters
}
```

## Performance

All generators are highly optimized:

- **White Noise**: ~5 ns/sample (single xorshift operation)
- **Pink Noise**: ~40 ns/sample (O(log N) updates)
- **Brown Noise**: ~10 ns/sample (simple integration)
- **fBM**: ~15 ns/sample per octave

No heap allocations in hot path. All state fits in CPU cache.

## Testing

Comprehensive test coverage includes:

1. **Range Tests**: Verify output stays in [-1.0, 1.0]
2. **Determinism Tests**: Same seed produces identical output
3. **Statistical Tests**: Verify mean near 0, reasonable RMS
4. **Spectral Tests**: Verify approximate spectral characteristics
5. **Edge Cases**: Zero seeds, extreme parameters, long runs

Run tests:
```bash
cargo test --lib nodes::noise_generators
```

Generate audio files for manual inspection:
```bash
cargo run --example noise_audio_test
```

## Implementation Details

### Random Number Generator

Uses Xorshift32 PRNG:
- Period: 2^32 - 1
- Fast: 3 XOR operations + 3 shifts
- Good quality for audio (passes basic randomness tests)
- Deterministic: Same seed = same sequence

### Pink Noise Algorithm

Voss-McCartney algorithm:
- Maintains 16 random generators
- Generator i updates every 2^i samples
- Determined by bit transitions in counter
- O(log N) complexity per sample
- Better than naive summation (O(N))

### Brown Noise DC Blocking

Integrates white noise but includes very slight leak:
- Leak coefficient: 0.9999
- Acts as DC blocker with ~0.5 Hz cutoff at 44.1kHz
- Prevents unbounded drift while maintaining brown character

### fBM Normalization

Normalizes by theoretical maximum amplitude:
```
max_amplitude = (1 - persistence^octaves) / (1 - persistence)
```

This ensures output stays in [-1, 1] regardless of parameters.

## Example: Reverb Modulation

```rust
use phonon::nodes::noise_generators::{FractalBrownianMotion, PinkNoise};

struct ModulatedReverb {
    allpass_noise: PinkNoise,
    chorus_noise: FractalBrownianMotion,
    // ... reverb state
}

impl ModulatedReverb {
    fn new(seed: u64) -> Self {
        Self {
            // Pink noise for allpass modulation
            allpass_noise: PinkNoise::new(seed),
            // fBM for chorus effect
            chorus_noise: FractalBrownianMotion::new(seed + 1, 3, 2.0, 0.4),
        }
    }

    fn process_sample(&mut self, input: f32) -> f32 {
        // Modulate allpass delays by ±1 sample
        let allpass_mod = self.allpass_noise.next_sample();

        // Very slow chorus (0.1 Hz)
        let chorus_mod = self.chorus_noise.next_sample_at_rate(0.1, 44100.0);

        // Use modulation values to create natural reverb
        // ... reverb processing
        input // placeholder
    }
}
```

## References

- **Voss-McCartney Algorithm**: Efficient pink noise generation
- **Brownian Motion**: Random walk process for 1/f² spectrum
- **Fractal Brownian Motion**: Multi-scale noise synthesis (Perlin, 1985)
- **Xorshift**: Fast PRNG by George Marsaglia (2003)

## See Also

- `examples/noise_generators_demo.rs` - Interactive demonstration
- `examples/noise_audio_test.rs` - Generate test audio files
- Unit tests in this file - Comprehensive verification
